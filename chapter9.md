# 第9章：全身控制与平衡

## 开篇

轮足机械臂机器人的全身控制是实现复杂动态行为的核心技术。不同于传统的固定基座机械臂，移动机器人需要在执行任务的同时保持动态平衡，这要求我们在统一的优化框架下协调所有关节、轮子和接触力。本章将深入探讨从经典的ZMP理论到现代的QP优化方法，帮助读者掌握设计和实现鲁棒全身控制器的关键技术。我们将特别关注如何处理欠驱动系统、接触约束和实时计算要求之间的权衡。

## 9.1 ZMP与稳定性准则

### 9.1.1 零力矩点(ZMP)理论基础

零力矩点是判断机器人动态稳定性的经典准则，最早由Vukobratović在1972年提出，至今仍是双足和多足机器人控制的基石。ZMP定义为地面上一点，在该点处地面反作用力产生的净力矩在水平方向上为零。这个概念的物理意义在于：如果我们能将所有分布的地面反力等效为作用在ZMP处的单一力，则该力不会使机器人产生绕该点的倾覆力矩。

对于平坦地面，ZMP的位置可以通过动量定理推导。考虑机器人作为多刚体系统，应用达朗贝尔原理，ZMP坐标计算如下：

$$
x_{zmp} = \frac{\sum_i m_i(x_i\ddot{z}_i - z_i\ddot{x}_i - g x_i)}{\sum_i m_i(\ddot{z}_i + g)}
$$

$$
y_{zmp} = \frac{\sum_i m_i(y_i\ddot{z}_i - z_i\ddot{y}_i - g y_i)}{\sum_i m_i(\ddot{z}_i + g)}
$$

其中 $m_i$ 是第 $i$ 个质点的质量，$(x_i, y_i, z_i)$ 是其位置，$g$ 是重力加速度。

值得注意的是，ZMP公式中包含了惯性项（加速度项），这使其不同于静态的压力中心(CoP)。在静态或准静态运动中，ZMP退化为CoP，但在动态运动中，两者可能显著不同。这种差异正是机器人能够执行动态运动（如跑步、跳跃）的理论基础。

**ZMP的数学性质**：
1. **唯一性**：对于给定的运动状态，ZMP位置唯一确定
2. **连续性**：连续运动产生连续的ZMP轨迹
3. **可控性**：通过调整身体姿态和加速度可以主动改变ZMP位置
4. **边界性**：物理可实现的ZMP必须位于支撑面内（静态稳定）或其附近（动态稳定）

### 9.1.2 支撑多边形与稳定裕度

支撑多边形(Support Polygon)是机器人稳定性分析的几何基础，由所有接触点的凸包(Convex Hull)定义。对于轮足机器人，这个概念需要特别注意，因为轮子的接触可能是点接触（理想情况）或小面积接触（实际情况）。

稳定性判据的核心原则：**ZMP必须位于支撑多边形内部才能保证不倾覆**。这可以从力矩平衡的角度理解：当ZMP位于支撑边界外时，意味着需要"拉力"来维持平衡，而地面只能提供推力。

```
      支撑多边形示意图（俯视图）
    
    FL ●━━━━━━━━━━━● FR
       ┃            ┃
       ┃     ZMP    ┃  <- 稳定区域
       ┃      ×     ┃
       ┃            ┃
    RL ●━━━━━━━━━━━● RR
    
    FL: 前左轮  FR: 前右轮
    RL: 后左轮  RR: 后右轮
    
    不同运动状态下的支撑多边形变化：
    静止：完整矩形
    单轮抬起：三角形
    对角支撑：线段（临界稳定）
```

稳定裕度(Stability Margin)定量描述了系统距离失稳的"距离"：

$$
\text{margin} = \min_{e \in \text{edges}} d(p_{zmp}, e)
$$

**稳定裕度的工程考量**：
1. **安全阈值**：实际控制中通常保持10-20%轮距的最小裕度
2. **动态裕度**：高速运动时需要更大裕度以应对模型误差
3. **方向依赖**：前后方向和左右方向的裕度要求可能不同
4. **负载影响**：携带负载会改变质心位置，减小有效裕度

对于轮足机器人的特殊考虑：
- **轮模式**：支撑多边形相对固定，通过调整质心位置维持稳定
- **足模式**：可主动改变支撑多边形形状和大小
- **过渡模式**：支撑多边形动态变化，需要预测性控制

### 9.1.3 CoM-ZMP动力学关系

质心(Center of Mass, CoM)与ZMP之间的动力学关系是理解和控制机器人平衡的关键。Kajita等人提出的线性倒立摆模型(Linear Inverted Pendulum Model, LIPM)提供了一个优雅的简化框架，将复杂的多体动力学简化为可解析求解的形式。

**LIPM的核心假设**：
1. 质心高度恒定：$z_{com} = \text{const}$
2. 角动量关于质心为零（无旋转）
3. 所有质量集中于质心

在这些假设下，水平面内的动力学方程简化为：

$$
\ddot{x}_{com} = \omega^2(x_{com} - x_{zmp})
$$

$$
\ddot{y}_{com} = \omega^2(y_{com} - y_{zmp})
$$

其中 $\omega = \sqrt{g/z_{com}}$ 是系统的自然频率。这个频率决定了系统的时间尺度：
- 典型值：$z_{com} = 1m$ → $\omega \approx 3.13 rad/s$ → 时间常数 $\tau = 1/\omega \approx 0.32s$
- 物理意义：系统从扰动恢复平衡的特征时间

**解析解与轨迹规划**：

给定初始状态 $(x_0, \dot{x}_0)$ 和常值 $x_{zmp}$，LIPM的解为：

$$
x_{com}(t) = x_{zmp} + (x_0 - x_{zmp})\cosh(\omega t) + \frac{\dot{x}_0}{\omega}\sinh(\omega t)
$$

这个解析解使得我们可以：
1. 快速预测未来状态
2. 计算到达目标所需的ZMP
3. 在线生成可行轨迹

**LIPM的扩展模型**：

**3D-LIPM**：考虑质心高度变化
$$
\ddot{x}_{com} = \frac{g}{z_{com}}(x_{com} - x_{zmp}) + \frac{2\dot{z}_{com}}{z_{com}}\dot{x}_{com}
$$

**LIPM with Flywheel**：加入角动量
$$
\ddot{x}_{com} = \omega^2(x_{com} - x_{zmp}) - \frac{\dot{L}_y}{mz_{com}}
$$

### 9.1.4 ZMP的局限性与扩展

传统ZMP理论虽然强大，但存在明显局限，特别是应用于轮足机器人时：

**基本假设的限制**：
1. **地面假设**：要求平坦、水平、刚性地面
2. **接触假设**：无滑动、充分摩擦、连续接触
3. **动力学假设**：忽略角动量效应、假设质心高度恒定

**理论局限性**：
- **保守性过强**：ZMP准则是充分非必要条件，某些动态稳定运动被排除
- **无法处理飞行相**：跳跃、奔跑等包含无接触相位的运动
- **忽略接触动力学**：碰撞、滑动等现象未被考虑

对于轮足机器人的特殊挑战：

**1. 虚拟ZMP (Virtual ZMP, VZMP)**：
轮子的滚动约束使得接触力分布与传统足式机器人不同。VZMP概念将轮地接触力等效映射：

$$
p_{vzmp} = \frac{\sum_i (p_i \times F_i) + \tau_{wheel,i}}{F_{total}}
$$

其中 $\tau_{wheel,i}$ 是轮子驱动力矩的贡献。

**2. 摩擦锥约束下的可行ZMP区域**：
有限摩擦系数 $\mu$ 限制了可实现的ZMP范围：

$$
\mathcal{Z}_{feasible} = \{p_{zmp} | \exists F_i \in \mathcal{F}_{\mu}, \sum_i (p_i - p_{zmp}) \times F_i = 0\}
$$

其中 $\mathcal{F}_{\mu} = \{F | |F_{tangential}| \leq \mu F_{normal}\}$ 是摩擦锥。

**3. 斜坡地形的广义ZMP**：
对于倾斜角度为 $\theta$ 的斜坡：

$$
x_{gzmp} = x_{zmp}\cos\theta - \frac{h}{\cos\theta}(a_x\cos\theta + (a_z + g)\sin\theta)/(a_z + g)
$$

**4. 柔性地面的等效ZMP**：
考虑地面刚度 $k_{ground}$ 和阻尼 $c_{ground}$：

$$
F_{ground} = k_{ground}\delta + c_{ground}\dot{\delta}
$$

ZMP位置需要迭代求解以满足力平衡。

## 9.2 QP优化的全身控制

现代机器人控制已经从传统的分层控制架构转向统一的优化框架。二次规划(Quadratic Programming, QP)因其凸性、计算效率和直观的物理意义，成为全身控制的标准方法。本节将详细介绍如何构建和求解适用于轮足机械臂的QP控制器。

### 9.2.1 全身动力学方程

轮足机械臂系统是一个高度复杂的多体系统，通常包含30-50个自由度。其完整动力学方程可通过拉格朗日方法或牛顿-欧拉递归算法导出：

$$
M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = S^T\tau + J_c^T F_c
$$

各项的物理意义和计算方法：

**质量矩阵 $M(q) \in \mathbb{R}^{n \times n}$**：
- 对称正定矩阵，描述系统的惯性特性
- 元素 $M_{ij}$ 表示第j个广义加速度对第i个广义力的影响
- 计算复杂度：$O(n^3)$（直接法）或 $O(n)$（递归法）

**科氏力和离心力 $C(q,\dot{q})\dot{q} \in \mathbb{R}^n$**：
- 速度相关的非线性项
- 可分解为：$C_{ijk} = \frac{1}{2}(\frac{\partial M_{ij}}{\partial q_k} + \frac{\partial M_{ik}}{\partial q_j} - \frac{\partial M_{jk}}{\partial q_i})$
- 满足斜对称性质：$\dot{q}^T(M - 2C)\dot{q} = 0$（能量守恒）

**重力项 $G(q) \in \mathbb{R}^n$**：
- 重力势能的梯度：$G = \frac{\partial U}{\partial q}$
- 对于串联链：$G_i = \sum_{j \geq i} m_j g^T J_{v,j}^i$

**选择矩阵 $S \in \mathbb{R}^{m \times n}$**：
区分驱动(actuated)和欠驱动(underactuated)自由度：
$$
S = \begin{bmatrix}
0_{m \times 6} & I_{m \times m}
\end{bmatrix}
$$
前6个自由度通常对应浮动基座（3个平移+3个旋转），后m个对应关节。

**接触雅可比 $J_c \in \mathbb{R}^{3k \times n}$**：
将广义速度映射到k个接触点的笛卡尔速度：
$$
v_{c,i} = J_{c,i}(q)\dot{q}
$$

对于轮足机器人，需要特别处理：
- **轮子滚动约束**：$J_{roll}\dot{q} = r\omega_{wheel}$
- **足式接触约束**：$J_{foot}\dot{q} = 0$（静止接触）

**动力学方程的数值特性**：
1. **条件数**：$\kappa(M) \sim O(10^2 - 10^3)$，需要数值稳定的求解器
2. **稀疏性**：树形结构导致M和J的稀疏模式，可利用加速计算
3. **对称性**：M的对称性减少一半存储和计算

### 9.2.2 任务空间控制目标

全身控制的核心在于同时满足多个可能冲突的任务目标。任务空间控制允许我们直接在操作空间（如笛卡尔空间）指定期望行为，而不是在复杂的关节空间。

**任务定义与分类**：

任务可以表示为一般形式：
$$
\ddot{x}_{task} = J_{task}\ddot{q} + \dot{J}_{task}\dot{q}
$$

常见任务类型包括：

**1. 质心(CoM)任务** - 维持平衡的核心：
$$
\ddot{x}_{com}^{des} = K_p^{com}(x_{com}^{ref} - x_{com}) + K_d^{com}(\dot{x}_{com}^{ref} - \dot{x}_{com}) + \ddot{x}_{com}^{ref}
$$

增益选择原则：
- $K_p^{com} \sim \omega_n^2$，其中 $\omega_n \approx 5-10$ rad/s（响应频率）
- $K_d^{com} \sim 2\zeta\omega_n$，其中 $\zeta \approx 0.7-1.0$（阻尼比）
- 考虑执行器带宽限制：$\omega_n < 0.3\omega_{actuator}$

**2. 末端执行器任务** - 操作和交互：
$$
\ddot{x}_{ee}^{des} = K_p^{ee}(x_{ee}^{ref} - x_{ee}) + K_d^{ee}(\dot{x}_{ee}^{ref} - \dot{x}_{ee}) + \ddot{x}_{ee}^{ref}
$$

对于轮足机器人的特殊考虑：
- 机械臂末端：精确位置控制，高增益
- 足端（摆动相）：轨迹跟踪，中等增益
- 轮子（地面接触）：速度控制，低位置增益

**3. 姿态任务** - 身体方向控制：

使用SO(3)上的对数映射处理旋转：
$$
\alpha^{des} = K_p^{ori} \log(R^{ref} R^T) + K_d^{ori}(\omega^{ref} - \omega)
$$

其中 $\log: SO(3) \rightarrow \mathfrak{so}(3)$ 是矩阵对数，提取旋转向量。

实际实现中的四元数形式：
$$
e_{ori} = q_{ref} \otimes q_{current}^{-1}
$$
$$
\alpha^{des} = K_p^{ori} \cdot 2 \cdot \text{sign}(e_{ori,w}) \cdot [e_{ori,x}, e_{ori,y}, e_{ori,z}]^T + K_d^{ori}(\omega^{ref} - \omega)
$$

**4. 动量任务** - 动态运动控制：

线动量控制：
$$
\dot{p}^{des} = m(\ddot{x}_{com}^{ref} + K_p^{lin}(x_{com}^{ref} - x_{com}) + K_d^{lin}(\dot{x}_{com}^{ref} - \dot{x}_{com}))
$$

角动量控制：
$$
\dot{L}^{des} = K_p^{ang}(L^{ref} - L) + \dot{L}^{ref}
$$

**5. 关节空间任务** - 配置优化：

姿态优化（远离奇异性）：
$$
\ddot{q}_{posture}^{des} = K_p^{joint}(q_{nominal} - q) + K_d^{joint}(0 - \dot{q})
$$

其中 $q_{nominal}$ 是期望的默认姿态，通常选择为：
- 最大化操作度：$\max \sigma_{min}(J)$
- 最小化势能：$\min U(q)$
- 中心配置：$q_{nominal} = (q_{max} + q_{min})/2$

**任务优先级策略**：

实际系统中任务常有明确优先级：

1. **严格优先级**（Strict Priority）：
   - Level 0：接触约束（最高）
   - Level 1：质心/平衡
   - Level 2：末端操作
   - Level 3：姿态优化（最低）

2. **加权优先级**（Weighted Priority）：
   使用权重矩阵 $W_i$ 柔性处理冲突：
   $$
   \min \sum_i ||W_i(A_i\ddot{q} - b_i)||^2
   $$

3. **混合策略**：
   关键任务严格优先，次要任务加权优化

### 9.2.3 QP问题构建

标准QP形式：

$$
\begin{aligned}
\min_{\ddot{q}, F_c, \tau} \quad & \sum_i w_i ||A_i\ddot{q} + b_i||^2 + w_\tau ||\tau||^2 + w_F ||F_c||^2 \\
\text{s.t.} \quad & M\ddot{q} + h = S^T\tau + J_c^T F_c \\
& \underline{F}_c \leq F_c \leq \bar{F}_c \\
& \underline{\tau} \leq \tau \leq \bar{\tau} \\
& \underline{\ddot{q}} \leq \ddot{q} \leq \bar{\ddot{q}}
\end{aligned}
$$

其中 $A_i\ddot{q} + b_i = 0$ 表示第 $i$ 个任务的加速度误差。

### 9.2.4 层级任务优化

处理任务冲突的层级方法：

```python
# 伪代码：层级QP求解
def hierarchical_qp(tasks, constraints):
    solution = None
    accumulated_constraints = constraints
    
    for priority_level in tasks:
        # 构建当前层级的QP
        qp = build_qp(priority_level, accumulated_constraints)
        solution = solve_qp(qp)
        
        # 将解作为等式约束加入下一层级
        accumulated_constraints.add(
            task_jacobian @ solution == task_acceleration
        )
    
    return solution
```

### 9.2.5 实时求解策略

为满足1kHz控制频率要求：

1. **热启动**：使用上一时刻的解初始化
2. **早停**：限制迭代次数
3. **稀疏性利用**：利用问题结构的稀疏性
4. **近似海塞矩阵**：使用对角近似减少计算

## 9.3 接触力分配与摩擦锥约束

### 9.3.1 接触模型

轮足机器人的接触可分为：

1. **点接触**：简化的轮地接触
2. **线接触**：轮子侧滑时
3. **面接触**：足式模式下的平面接触

每种接触的力空间维度不同：
- 点接触：3D力
- 线接触：4D（3D力 + 1D力矩）
- 面接触：6D（3D力 + 3D力矩）

### 9.3.2 摩擦锥线性化

库仑摩擦锥的非线性约束：

$$
\sqrt{f_x^2 + f_y^2} \leq \mu f_z
$$

线性化为金字塔约束（4面体）：

$$
\begin{aligned}
|f_x| &\leq \frac{\mu}{\sqrt{2}} f_z \\
|f_y| &\leq \frac{\mu}{\sqrt{2}} f_z
\end{aligned}
$$

或使用8面体获得更好的近似：

$$
|f_x| + |f_y| \leq \mu f_z
$$

### 9.3.3 接触力优化分配

给定期望的净力矩 $w^{des} = [f^{des}, \tau^{des}]^T$，分配到各接触点：

$$
\min_{F_c} \sum_i ||F_{c,i}||^2_Q + \lambda ||A_c F_c - w^{des}||^2
$$

其中 $A_c$ 是接触力到净力矩的映射矩阵：

$$
A_c = \begin{bmatrix}
I_3 & I_3 & \cdots & I_3 \\
[p_1]_\times & [p_2]_\times & \cdots & [p_n]_\times
\end{bmatrix}
$$

### 9.3.4 轮子特殊约束

轮子的滚动约束要求切向力与驱动力矩一致：

$$
f_{wheel,tangent} = \tau_{wheel} / r_{wheel}
$$

转向轮增加额外约束：

$$
f_{lateral} \cos(\delta) - f_{longitudinal} \sin(\delta) = 0
$$

其中 $\delta$ 是转向角。

### 9.3.5 接触状态切换

处理接触建立/断开的平滑过渡：

```
接触力profile：
    
Force
  ▲
  │     ___稳定接触___
  │    /               \
  │   /                 \
  │  /建立              断开\
  │ /                       \
──┴─────────────────────────► Time
  t0  t1              t2  t3
```

使用sigmoid函数平滑过渡：

$$
\gamma(t) = \frac{1}{1 + e^{-k(t - t_{switch})}}
$$

## 9.4 动态平衡与步态转换

### 9.4.1 动态行走的稳定性

与静态稳定不同，动态行走允许ZMP暂时离开支撑多边形，利用角动量维持平衡：

$$
\dot{L} = \sum_i (p_i - p_{com}) \times F_i + \tau_{external}
$$

捕获点(Capture Point)定义：

$$
\xi = x_{com} + \frac{\dot{x}_{com}}{\omega}
$$

稳定条件：捕获点必须在可达支撑区域内。

### 9.4.2 轮足模式切换策略

轮足机器人的独特优势在于可以根据地形和任务需求切换运动模式：

1. **纯轮模式**：高速、高效、平坦地形
2. **轮足混合**：中速、复杂地形
3. **纯足模式**：低速、极端地形（楼梯、碎石）

模式切换状态机：

```
    ┌─────────┐
    │纯轮模式 │◄────────┐
    └────┬────┘         │
         │              │
    v > v_max      稳定性恢复
         │              │
         ▼              │
    ┌─────────┐         │
    │混合模式 │─────────┘
    └────┬────┘    
         │
    地形复杂度 > θ
         │
         ▼
    ┌─────────┐
    │纯足模式 │
    └─────────┘
```

### 9.4.3 步态生成与优化

**相位协调**：使用中央模式发生器(CPG)或优化方法生成步态：

$$
\phi_i(t) = \omega t + \phi_{i,0} + \sum_j w_{ij} \sin(\phi_j - \phi_i)
$$

**占空比优化**：根据速度和稳定性要求调整支撑相/摆动相比例：

$$
\text{duty factor} = \frac{T_{stance}}{T_{stance} + T_{swing}}
$$

典型值：
- Walk: 0.75
- Trot: 0.5
- Gallop: 0.4

### 9.4.4 角动量规划

全身角动量的主动调节用于动态平衡：

$$
L = \sum_i I_i \omega_i + \sum_i m_i (p_i - p_{com}) \times v_i
$$

通过优化问题规划角动量轨迹：

$$
\min \int_0^T ||\dot{L}(t) - \dot{L}^{ref}(t)||^2 dt
$$

约束于可行的接触力和关节限制。

### 9.4.5 推力恢复策略

受扰动后的平衡恢复策略层级：

1. **踝策略**：小扰动，调整CoP位置
2. **髋策略**：中等扰动，调整角动量
3. **步进策略**：大扰动，改变支撑位置

决策阈值基于线性倒立摆的可行域：

$$
|\xi - p_{support}| > d_{critical} \Rightarrow \text{需要步进}
$$

## 案例研究：波士顿动力Atlas的动态平衡

### 背景

Atlas是波士顿动力开发的人形机器人，展示了卓越的动态运动能力，包括跑步、跳跃和后空翻。其全身控制系统是业界标杆。

### 控制架构

Atlas采用三层控制架构：

1. **高层规划器**（10-50Hz）
   - 轨迹优化
   - 步态规划
   - 任务分解

2. **中层控制器**（200-500Hz）
   - 全身QP控制
   - 平衡控制
   - 接触力分配

3. **底层控制器**（1-5kHz）
   - 关节伺服
   - 力/力矩控制
   - 传感器融合

### 关键技术创新

**1. 预测控制与MPC**

Atlas使用模型预测控制处理动态运动：

$$
\min_{u_{0:N-1}} \sum_{k=0}^{N-1} ||x_k - x_k^{ref}||_Q + ||u_k||_R
$$

预测时域通常为1-2秒，允许机器人"预见"未来并提前调整。

**2. 混合动力学建模**

结合刚体动力学和简化模型：
- 全身：30+ DoF刚体模型（精确但计算密集）
- 规划：3D SLIP模型（简单但捕获主要动态）

**3. 鲁棒接触检测**

使用多传感器融合检测接触：
- 力传感器：直接测量
- IMU + 运动学：间接推断
- 视觉：预测接触

接触置信度估计：

$$
p_{contact} = \sigma(w_f f_{measured} + w_a a_{residual} + w_v v_{predicted})
$$

### 性能指标

Atlas在各种任务中的表现：

| 指标 | 数值 | 备注 |
|------|------|------|
| 最大步行速度 | 2.5 m/s | 平坦地形 |
| 跳跃高度 | 0.5 m | 垂直跳跃 |
| 平衡恢复 | 30 cm | 最大推力恢复距离 |
| 控制延迟 | < 5 ms | 传感器到执行器 |
| 能耗 | 500 W | 步行时平均功率 |

### 经验教训

1. **计算资源权衡**：复杂模型 vs 实时性能
2. **传感器冗余**：单一传感器故障不应导致失败  
3. **平滑过渡**：模式切换必须连续
4. **学习组件**：某些参数通过强化学习优化

## 高级话题：Centroidal动力学与角动量规划

### Centroidal动力学框架

Centroidal动力学将机器人简化为质心处的集总动量：

$$
\begin{bmatrix}
m\ddot{c} \\
\dot{L}
\end{bmatrix} = 
\begin{bmatrix}
\sum_i f_i \\
\sum_i (p_i - c) \times f_i + \tau_i
\end{bmatrix} + 
\begin{bmatrix}
mg \\
0
\end{bmatrix}
$$

其中 $c$ 是质心位置，$L$ 是关于质心的角动量。

### 质心复合刚体惯量(CCRBI)

CCRBI定义了质心角动量与平均角速度的关系：

$$
L = I_G(\q) \omega_{avg}
$$

$I_G$ 是配置相关的3×3矩阵，可离线计算并存储。

### 动量空间的凸优化

在动量空间中，动力学约束变为线性：

$$
\begin{aligned}
\dot{h} &= Ag + u \\
y &= Cx
\end{aligned}
$$

其中 $h = [mc\dot{}, L]^T$ 是广义动量，$u$ 是控制输入。

### 可达动量空间

给定接触配置，可达动量变化率形成凸多面体：

$$
\mathcal{U} = \{u | u = A_c f_c, f_c \in \mathcal{F}_c\}
$$

这允许快速验证动作可行性。

### 角动量的最优分配

将期望角动量分配到各肢体：

$$
\min_{\dot{q}} ||\dot{q}||^2 \quad \text{s.t.} \quad L^{des} = \sum_i L_i(\q, \dot{q})
$$

使用伪逆或QP求解。

### 实际应用考虑

1. **计算效率**：Centroidal模型比全身模型快100倍
2. **规划精度**：足够用于轨迹规划，需要全身控制器跟踪
3. **在线适应**：可实时重规划以应对扰动

## 本章小结

本章系统介绍了轮足机械臂机器人的全身控制与平衡技术。核心要点包括：

### 关键概念
1. **ZMP理论**：零力矩点提供了判断动态稳定性的直观准则，但需要根据轮足系统特点进行扩展
2. **QP优化框架**：将多任务控制问题转化为二次规划，实现实时全身协调
3. **接触力分配**：考虑摩擦锥约束的力优化分配是保证运动可行性的关键
4. **动态平衡**：利用角动量和捕获点概念扩展静态稳定性到动态场景
5. **Centroidal动力学**：提供计算高效的规划框架，将复杂动力学简化为质心动量演化

### 关键公式回顾

| 概念 | 公式 | 用途 |
|------|------|------|
| ZMP位置 | $x_{zmp} = \frac{\sum m_i(x_i\ddot{z}_i - z_i\ddot{x}_i - gx_i)}{\sum m_i(\ddot{z}_i + g)}$ | 稳定性判断 |
| LIPM动力学 | $\ddot{x}_{com} = \omega^2(x_{com} - x_{zmp})$ | 轨迹规划 |
| 全身动力学 | $M\ddot{q} + h = S^T\tau + J_c^TF_c$ | QP约束 |
| 摩擦锥 | $\|\|f_t\|\| \leq \mu f_n$ | 接触约束 |
| 捕获点 | $\xi = x_{com} + \dot{x}_{com}/\omega$ | 步进决策 |

### 设计要点
- 选择合适的模型复杂度：规划用简化模型，控制用详细模型
- 实时性优先：宁可次优解也要保证控制频率
- 传感器融合：多源信息提高鲁棒性
- 平滑过渡：模式切换和接触状态变化需要连续性

## 练习题

### 基础题

**题目1**：给定一个四轮机器人，轮距为1m×0.6m（长×宽），质心高度0.5m，计算在质心横向加速度为2m/s²时的ZMP位置。
<details>
<summary>答案</summary>

使用简化的LIPM模型：
- 自然频率：$\omega = \sqrt{g/h} = \sqrt{9.8/0.5} = 4.43$ rad/s
- 横向ZMP偏移：$y_{zmp} = y_{com} - \ddot{y}_{com}/\omega^2 = 0 - 2/19.6 = -0.102$ m

ZMP向加速度相反方向偏移10.2cm，仍在支撑多边形内（宽度60cm），系统稳定。
</details>

**题目2**：一个全身控制QP问题有3个任务：质心追踪（权重10）、手臂末端追踪（权重5）、姿态保持（权重1）。如果质心任务和手臂任务发生冲突，QP求解器会如何权衡？
<details>
<summary>答案</summary>

QP求解器会根据权重比例分配误差：
- 质心任务权重是手臂任务的2倍（10:5）
- 在冲突时，求解器会优先满足质心任务，允许手臂任务有更大误差
- 具体分配遵循：质心误差²×10 + 手臂误差²×5 最小化
- 理论上，稳态时质心误差约为手臂误差的$\sqrt{5/10} = 0.707$倍
</details>

**题目3**：摩擦系数μ=0.6的接触点，最大法向力100N，计算其摩擦锥允许的最大切向力。使用4面体和8面体线性化，分别计算最大值。
<details>
<summary>答案</summary>

真实摩擦锥：$F_{t,max} = \mu F_n = 0.6 × 100 = 60$ N

4面体线性化（保守）：
- 单方向最大力：$F_{x,max} = \mu F_n / \sqrt{2} = 60/1.414 = 42.4$ N
- 对角方向：$\sqrt{42.4^2 + 42.4^2} = 60$ N（恰好相切）

8面体线性化：
- 约束：$|F_x| + |F_y| \leq \mu F_n = 60$ N  
- 单方向最大：60 N
- 对角方向最大：$F_x = F_y = 30$ N，合力$42.4$ N（保守）
</details>

**题目4**：机器人从轮式模式切换到足式模式，切换时间0.5秒，使用sigmoid函数$\gamma(t) = 1/(1+e^{-k(t-t_0)})$平滑过渡。要求在t=0.25s时达到50%切换，计算k值。
<details>
<summary>答案</summary>

在$t = t_0$时，$\gamma(t_0) = 0.5$（sigmoid的中点）
因此$t_0 = 0.25$秒

要求0.5秒完成切换（从5%到95%），sigmoid函数性质：
- $\gamma(t_0 - 2/k) \approx 0.12$
- $\gamma(t_0 + 2/k) \approx 0.88$

所以$4/k = 0.5$，得$k = 8$ s⁻¹

验证：$\gamma(0) = 1/(1+e^{8×0.25}) = 0.12$，$\gamma(0.5) = 1/(1+e^{-8×0.25}) = 0.88$
</details>

### 挑战题

**题目5**：设计一个简化的QP控制器，同时优化6个自由度机械臂的末端位置追踪和避奇异性。写出完整的QP问题formulation，包括目标函数和约束。
<details>
<summary>提示与答案</summary>

**提示**：考虑任务雅可比、奇异值分解、关节限位

**答案**：
目标函数：
$$\min_{\dot{q}} w_1\|\|J\dot{q} - v_{des}\|\|^2 + w_2\|\|\dot{q}\|\|^2 + w_3/\sigma_{min}^2$$

约束：
1. 关节限位：$\dot{q}_{min} \leq \dot{q} \leq \dot{q}_{max}$
2. 关节位置限制：$(q_{min} - q)/\Delta t \leq \dot{q} \leq (q_{max} - q)/\Delta t$
3. 操作度保持：$\sigma_{min}(J) \geq \sigma_{threshold}$

其中$\sigma_{min}$是雅可比最小奇异值，可通过增广目标函数或约束实现。
</details>

**题目6**：轮足机器人在斜坡上（倾角15°）保持静止，四个轮子形成1m×0.6m矩形，质量50kg，质心高度0.4m。计算各轮所需的最小法向力，以及对摩擦系数的要求。
<details>
<summary>提示与答案</summary>

**提示**：建立坐标系，考虑重力分量，力矩平衡

**答案**：
坐标系：x沿斜坡向上，z垂直斜坡向上

重力分量：
- 法向：$F_n = mg\cos(15°) = 50×9.8×0.966 = 473$ N
- 切向：$F_t = mg\sin(15°) = 50×9.8×0.259 = 127$ N

力矩平衡（防止后翻）：
- 重心投影偏移：$\Delta x = h\sin(15°) = 0.4×0.259 = 0.104$ m
- 前轮总法向力：$F_{front} = 473×(0.5+0.104)/1.0 = 286$ N
- 后轮总法向力：$F_{rear} = 473×(0.5-0.104)/1.0 = 187$ N

每个轮子：
- 前轮：143 N（法向），31.75 N（切向）
- 后轮：93.5 N（法向），31.75 N（切向）

最小摩擦系数：$\mu_{min} = 31.75/93.5 = 0.34$（后轮最苛刻）
</details>

**题目7**：实现一个基于Centroidal动力学的轨迹优化问题。机器人需要从静止跳跃0.3m高，优化起跳和落地过程的质心轨迹和角动量。列出优化变量、目标函数和约束。
<details>
<summary>提示与答案</summary>

**提示**：考虑飞行相位无接触力、角动量守恒、落地冲击

**答案**：
优化变量：
- 质心轨迹：$c(t), \dot{c}(t)$
- 角动量轨迹：$L(t)$  
- 接触力：$f_i(t)$（仅地面接触相）
- 相位时间：$t_{takeoff}, t_{landing}$

目标函数：
$$\min \int_0^T (\|\|f\|\|^2 + w_L\|\|\dot{L}\|\|^2) dt + w_t T$$

约束：
1. 动力学（接触相）：
   - $m\ddot{c} = \sum f_i - mg$
   - $\dot{L} = \sum (p_i - c) × f_i$

2. 飞行相（$t \in [t_{takeoff}, t_{landing}]$）：
   - $\ddot{c} = -g$（仅重力）
   - $\dot{L} = 0$（角动量守恒）

3. 边界条件：
   - $c(0) = c_0, \dot{c}(0) = 0$（静止开始）
   - $c_z(t_{peak}) = 0.3$ m
   - $\dot{c}(T) = 0$（静止结束）

4. 接触约束：
   - 摩擦锥：$\|\|f_{t,i}\|\| \leq \mu f_{n,i}$
   - 单边接触：$f_{n,i} \geq 0$
   - ZMP约束（接触相）

5. 物理限制：
   - 最大地面反力：$f_{n,i} \leq f_{max}$
   - 关节力矩限制（通过接触力雅可比映射）
</details>

**题目8（开放题）**：讨论如何将强化学习集成到全身控制框架中。考虑：哪些参数适合学习？如何保证安全性？sim-to-real的挑战？
<details>
<summary>思考方向</summary>

可学习参数：
- QP任务权重的动态调整
- 参考轨迹生成网络
- 接触时序和步态参数
- 扰动恢复策略选择

安全保证：
- 保留底层QP保证物理约束
- 学习残差/修正项而非完整策略
- 安全过滤器对RL输出进行约束
- 课程学习从简单到复杂

Sim-to-real：
- 域随机化：摩擦、质量、延迟
- 系统辨识优化仿真参数
- 使用特权信息训练teacher
- 适应层处理现实传感器噪声

实际案例：
- Cassie：RL学习步态，QP保证平衡
- ANYmal：RL学习地形适应，MPC保证稳定
- Atlas：RL优化能耗，传统控制保证安全
</details>

## 常见陷阱与错误

### 1. ZMP理解误区
- **错误**：认为ZMP必须始终在支撑多边形中心
- **正确**：ZMP可以在多边形内任意位置，甚至短暂超出（动态运动）

### 2. QP求解失败
- **原因**：约束矛盾、数值病态、初始化差
- **解决**：层级化约束、正则化、热启动、约束松弛

### 3. 摩擦锥线性化过度保守
- **问题**：4面锥在对角方向损失40%可用摩擦力
- **改进**：使用8面或16面锥，或二阶锥规划(SOCP)

### 4. 接触切换震荡
- **现象**：接触建立/断开时控制输出剧烈变化
- **预防**：平滑切换函数、提前规划、阻抗控制过渡

### 5. 实时性能不足
- **症状**：控制延迟导致不稳定
- **优化**：简化模型、并行计算、查找表、早停策略

### 6. 传感器噪声放大
- **问题**：微分项放大测量噪声
- **对策**：低通滤波、状态估计器、鲁棒控制设计

### 调试技巧
1. **可视化工具**：实时显示ZMP、CoM、接触力
2. **数据记录**：高频记录所有状态用于事后分析
3. **仿真验证**：先在仿真中调试，注意sim-to-real差异
4. **增量测试**：从简单任务逐步增加复杂度
5. **故障注入**：主动测试传感器故障、通信延迟等

## 最佳实践检查清单

### 设计阶段
- [ ] 明确稳定性要求：静态 vs 动态
- [ ] 选择合适的控制架构：集中式 vs 分布式
- [ ] 确定控制频率：规划(10-50Hz)、控制(200-1000Hz)
- [ ] 设计冗余方案：传感器、执行器、算法

### 实现阶段  
- [ ] QP问题良好条件数：检查海塞矩阵
- [ ] 约束优先级明确：硬约束 vs 软约束
- [ ] 数值稳定性：避免除零、奇异性
- [ ] 实时性验证：最坏情况执行时间

### 测试阶段
- [ ] 静态平衡测试：各种姿态、负载
- [ ] 动态平衡测试：推力恢复、外部扰动
- [ ] 模式切换测试：所有可能的转换
- [ ] 极限工况测试：最大速度、最大负载
- [ ] 长时间运行测试：内存泄漏、数值漂移

### 优化阶段
- [ ] 性能分析：瓶颈识别、热点优化
- [ ] 参数调优：系统辨识、自动调参
- [ ] 能耗优化：减少不必要的运动
- [ ] 鲁棒性提升：噪声注入、参数摄动

### 维护阶段
- [ ] 日志系统：关键事件、异常记录
- [ ] 性能监控：实时指标、趋势分析
- [ ] 故障诊断：自检程序、故障定位
- [ ] 更新机制：参数、固件、算法
